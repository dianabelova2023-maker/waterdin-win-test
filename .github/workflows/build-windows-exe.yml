name: Build Windows EXE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r github_upload_min/requirements.txt
          pip install pyinstaller

      - name: Set 7-day trial policy
        shell: pwsh
        run: |
          python -c "import json; from datetime import datetime, timedelta, timezone; from pathlib import Path; p=Path('github_upload_min/src'); p.mkdir(parents=True, exist_ok=True); exp=(datetime.now(timezone.utc)+timedelta(days=7)).strftime('%Y-%m-%dT%H:%M:%SZ'); Path('github_upload_min/src/trial_policy.json').write_text(json.dumps({'expires_utc': exp}), encoding='utf-8')"

      - name: Generate launcher (browser mode)
        shell: pwsh
        run: |
          @'
          from __future__ import annotations
          import os, sys, time, socket, threading, webbrowser, json
          from datetime import datetime, timezone
          from pathlib import Path
          import streamlit.config as st_config
          from streamlit.web import bootstrap

          def _base_dir() -> Path:
              if getattr(sys, "frozen", False) and hasattr(sys, "_MEIPASS"):
                  return Path(sys._MEIPASS)
              return Path(__file__).resolve().parent

          def _find_free_port() -> int:
              with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                  s.bind(("127.0.0.1", 0))
                  return int(s.getsockname()[1])

          def _wait_server(url: str, timeout_s: float = 30.0) -> bool:
              import urllib.request
              end = time.time() + timeout_s
              for _ in range(int(timeout_s * 4)):
                  for check in (f"{url}/_stcore/health", f"{url}/healthz"):
                      try:
                          with urllib.request.urlopen(check, timeout=1.5) as r:
                              if int(r.status) == 200:
                                  return True
                      except Exception:
                          pass
                  time.sleep(0.25)
              return False

          def _run_streamlit(app_path: Path, port: int, state: dict) -> threading.Thread:
              def _target():
                  try:
                      st_config.set_option("global.developmentMode", False, "cmd")
                      st_config.set_option("server.port", int(port), "cmd")
                      st_config.set_option("server.address", "127.0.0.1", "cmd")
                      st_config.set_option("server.headless", True, "cmd")
                      st_config.set_option("browser.serverAddress", "127.0.0.1", "cmd")
                      st_config.set_option("browser.serverPort", int(port), "cmd")
                      st_config.set_option("server.fileWatcherType", "none", "cmd")
                      bootstrap._set_up_signal_handler = lambda _server: None  # type: ignore[attr-defined]
                      bootstrap.run(
                          str(app_path), False, [],
                          {
                              "server.headless": True,
                              "server.address": "127.0.0.1",
                              "server.port": port,
                              "browser.gatherUsageStats": False,
                              "global.developmentMode": False,
                              "server.fileWatcherType": "none",
                          },
                      )
                  except Exception as exc:
                      state["error"] = repr(exc)

              t = threading.Thread(target=_target, daemon=True)
              t.start()
              return t

          def _is_trial_expired(base: Path) -> bool:
              p = base / "src" / "trial_policy.json"
              if not p.exists():
                  return False
              try:
                  raw = json.loads(p.read_text(encoding="utf-8"))
                  exp = str(raw.get("expires_utc", "")).strip()
                  if exp.endswith("Z"):
                      exp = exp[:-1] + "+00:00"
                  dt = datetime.fromisoformat(exp)
                  return datetime.now(timezone.utc) >= dt.astimezone(timezone.utc)
              except Exception:
                  return False

          def main() -> int:
              base = _base_dir()
              app_path = base / "src" / "app.py"
              if not app_path.exists():
                  raise FileNotFoundError(f"Streamlit app not found: {app_path}")
              if _is_trial_expired(base):
                  return 0
              os.chdir(base)
              os.environ["BROWSER"] = "none"
              port = _find_free_port()
              url = f"http://127.0.0.1:{port}"
              state = {}
              _run_streamlit(app_path, port, state)
              if not _wait_server(url):
                  raise RuntimeError(f"Failed to start local server: {state.get('error', 'unknown')}")
              webbrowser.open(url)
              while True:
                  time.sleep(1)

          if __name__ == "__main__":
              raise SystemExit(main())
          '@ | Set-Content -Encoding UTF8 launcher.py

      - name: Build Waterdin EXE
        shell: pwsh
        run: |
          pyinstaller `
            --noconfirm `
            --windowed `
            --name "Waterdin" `
            --add-data "github_upload_min/src;src" `
            --add-data "github_upload_min/data;data" `
            --add-data "github_upload_min/assets;assets" `
            --collect-all docx `
            --collect-all streamlit `
            launcher.py

      - name: Prepare portable package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release | Out-Null
          Copy-Item -Recurse -Force dist/Waterdin release/Waterdin
          @"
          Waterdin (Windows portable)
          1) Распакуйте архив.
          2) Запустите Waterdin\Waterdin.exe
          3) Если SmartScreen спросит: More info -> Run anyway
          "@ | Set-Content -Encoding UTF8 release/README_WINDOWS_EXE.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Waterdin_Windows_EXE
          path: release/*
