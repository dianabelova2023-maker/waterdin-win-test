name: Build Windows EXE

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_native.txt
          pip install pyinstaller

      - name: Set 7-day trial policy
        shell: pwsh
        run: |
          python -c "import json; from datetime import datetime, timedelta, timezone; from pathlib import Path; p=Path('src'); p.mkdir(parents=True, exist_ok=True); exp=(datetime.now(timezone.utc)+timedelta(days=7)).strftime('%Y-%m-%dT%H:%M:%SZ'); Path('src/trial_policy.json').write_text(json.dumps({'expires_utc': exp}), encoding='utf-8')"

      - name: Build Waterdin EXE
        shell: pwsh
        run: |
          pyinstaller `
            --noconfirm `
            --windowed `
            --name "Waterdin" `
            --add-data "src;src" `
            --add-data "data;data" `
            --add-data "assets;assets" `
            --hidden-import docx `
            --collect-all docx `
            --collect-all streamlit `
            --collect-all webview `
            src/native_main.py

      - name: Prepare portable package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release | Out-Null
          Copy-Item -Recurse -Force dist/Waterdin release/Waterdin
          @"
          Waterdin (Windows portable)

          1) Распакуйте архив.
          2) Запустите Waterdin\Waterdin.exe
          3) При первом запуске SmartScreen может спросить подтверждение - нажмите:
             More info -> Run anyway

          Примечание:
          - Python и терминал не нужны.
          - Для работы встроенного окна требуется Microsoft Edge WebView2 Runtime
            (обычно уже установлен в Windows 10/11).
          "@ | Set-Content -Encoding UTF8 release/README_WINDOWS_EXE.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Waterdin_Windows_EXE
          path: release/*
